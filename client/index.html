<html >
<head>
  <title>Meetings</title>
  <!-- require angular -->
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular-route.min.js"></script>


  <script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>

  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyC7Kx1tobfXMXf3MEAAdSlCUb99txm-H8Q&libraries=places' ></script>


  <style type="text/css">

  #searchform1{
    font-size: 14px;
    color: black;
  }

  .search-label{
    font-size: 14px;
    color: black;
  }

  .row_small{
    margin-top: 200px;
  }

  .waves-effect{
    margin-top: 150px;
  }

  .search-marker{
    font-size: 20px;
  }

  #map{
    width: 800px;
    height: 800px;
    margin-left: 50px;
  }

  </style>


  <script>
  var meetingsApp = angular.module('meetingsApp', ['ngAutocomplete']);

  var map;
  var service;
  var infowindow;

  var search_location;
  var radius_from_location = 5000;
  var map_zoom_level = 12;

  meetingsApp.factory('meetingFactory', function($http) {
    var factory = {};
    var meetings = [];
    
    factory.create = function(meetingone, callback) {
      var m1 = encodeURI(meetingone);
      $http.get('https://maps.googleapis.com/maps/api/geocode/json?address='+m1+'&key=AIzaSyC7Kx1tobfXMXf3MEAAdSlCUb99txm-H8Q')
      .then(function(data){

        var lat1= data.data.results[0].geometry.location.lat;
        var lng1= data.data.results[0].geometry.location.lng;
        var results = {lat: lat1, lng: lng1};
        callback(results);
      });
    }
    return factory;

  });

  meetingsApp.controller('meetingsController', function($scope, meetingFactory){
    $scope.autocomplete;


    $scope.addmeetings = function() {

        // note the use of callbacks here
        meetingFactory.create($scope.location.one, function(data) {
          console.log('scope location one ' + $scope.location.one);
          console.log('location one got back data', data);
          $scope.locationonepoints = data;
          console.log('should match with location one ', $scope.locationonepoints);

        });

        meetingFactory.create($scope.location.two, function (data) {
          console.log('scope location two ' + $scope.location.two);
          console.log('second lat ', data);
          $scope.locationtwopoints = data;
          console.log('should match ', $scope.locationtwopoints);  
          $scope.midpoint = getMidpoint($scope.locationonepoints, $scope.locationtwopoints); 
          $scope.lat = $scope.midpoint[0];
          console.log($scope.lat, 'midpoint lat')
          $scope.lng = $scope.midpoint[1];
          console.log($scope.lng, 'midpoint lng')
          initialize();



          function callback(results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
              for (var i = 0; i < results.length; i++) {
                var place = results[i];
                console.log('place', place);
                createMarker(results[i]);
              }
            }
          }

          function createMarker(place) {
            var placeLoc = place.geometry.location;
            var marker = new google.maps.Marker({
              map: map,
              position: place.geometry.location
            });

            google.maps.event.addListener(marker, 'click', function() {
              infowindow.setContent(place.name);
              infowindow.open(map, this);
            });
          }

          function initialize() {
            var pyrmont = new google.maps.LatLng($scope.lat,$scope.lng);

            map = new google.maps.Map(document.getElementById('map'), {
              center: pyrmont,
              mapTypeId: google.maps.MapTypeId.ROADMAP,
              zoom: 15
            });

            infowindow = new google.maps.InfoWindow();
            console.log('activity', $scope.activity.name);
            var service = new google.maps.places.PlacesService(map);
            service.nearbySearch({
              location: pyrmont,
              radius: 500,
              type: $scope.activity.name
            }, callback);
          }
        });
      }

      var getMidpoint = function(locationone, locationtwo) {
       console.log(locationone, locationtwo);
       var lat1 = locationone.lat;
       var lng1 = locationone.lng;
       var lat2 = locationtwo.lat;
       var lng2 = locationtwo.lng;

       Math.degrees = function(rad) {
        return rad * (180 / Math.PI);
        }
        Math.radians = function(deg) {
          return deg * (Math.PI / 180);
        }
        lat1 = Math.radians(lat1);
        lng1 = Math.radians(lng1);
        lat2 = Math.radians(lat2);
        lng = Math.radians(lng2);
        bx = Math.cos(lat2) * Math.cos(lng - lng1)
        by = Math.cos(lat2) * Math.sin(lng - lng1)
        lat3 = Math.atan2(Math.sin(lat1) + Math.sin(lat2), Math.sqrt((Math.cos(lat1) + bx) * (Math.cos(lat1) + bx) + Math.pow(by, 2)));
        lon3 = lng1 + Math.atan2(by, Math.cos(lat1) + bx);
        var resultarr = [Math.degrees(lat3), Math.degrees(lon3)];
        console.log('the value is ', resultarr);
        return resultarr;
    }

    $scope.locationone = function() {
      var autocomplete = new google.maps.places.Autocomplete((document.getElementById('searchbox2')), {types: ['geocode']});
    }

    $scope.locationtwo = function() {
      var autocomplete = new google.maps.places.Autocomplete((document.getElementById('searchbox3')), {types: ['geocode']});
    }
      });








</script>
<script src="./js/ngAutocomplete.js"></script>

</head>
<!-- everything in the body is going to use the friends controller (this gives us access to the friends controller $scope) -->
<body ng-app='meetingsApp' ng-controller="meetingsController">
   <!--  <a href="#/customers">Customers</a>
    <a href="#/orders">Orders</a>
    <div ng-view=''>
    </div> -->

    <!--============================= Search ==================================-->
    <div class="row_small">
      <form class="col s12" id="searchform1" name="meetingsForm">
        <div class="row">
          <div class="col l4 offset-l1 no-padding">
            <div class='col l4 s3 align-right'>
              <label class="search-label">We want</label>
            </div>
            <div class="col s1">
              <img src="http://airplatter.com/wp-content/uploads/2016/01/400-TableTalk-icon-food-rgb-2.png" width="25" height="25" class='search-marker'/>
            </div>

            <div class="input-field col l7 s8">
              <input ng-model="activity.name" id="activity" placeholder="lunch" type="text" class="search-text">
            </div>
          </div>

          <div class="col l4 no-padding">
            <div class='col s3 center'>
              <label class="search-label">in between</label>
            </div>
            <div class="col s1">
              <img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" class='search-marker'/>
            </div>
            <div class="input-field col s8">
              <input ng-autocomplete ng-model="location.one" id="searchbox2" placeholder="where I am" type="text" class="search-text" />
            </div>
            <div class='col s3 center'>
              <label class="search-label">and</label>
            </div>

            <div class="col s1">
              <img src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png" class='search-marker'/>
            </div>
            <div class="input-field col s8">
              <input  ng-autocomplete ng-model="location.two" id="searchbox3" placeholder="where they are" type="text" class="search-text">
            </div>
          </div>
          <div class="col l2 no-padding">
            <div class='col s2'>
              <button ng-click="addmeetings()" type = 'submit' id="search-button" class="waves-effect waves-light btn-large"><i class="material-icons">search</i></button>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div id="map"></div>
   
  </body>
  </html>